<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Form Dana Swadaya Warga Untuk 17an</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka&display=swap" rel="stylesheet">
    <style>
        body {
          font-family: 'Fredoka', sans-serif;
          background: linear-gradient(to bottom right, #fff3f3, #ffecec);
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }
        header {
          background: linear-gradient(to right, red, white);
          padding: 1rem;
          text-align: center;
          color: white;
          font-weight: bold;
          font-size: 1.5rem;
        }
        footer {
          background-color: #dc3545;
          color: white;
          text-align: center;
          padding: 0.8rem;
          margin-top: auto;
        }
        .card {
          border-left: 10px solid red;
        }
        .independence-banner {
          background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/Flag-map_of_Indonesia.svg/1280px-Flag-map_of_Indonesia.svg.png') no-repeat center right;
          background-size: 100px;
          padding-right: 120px;
        }
    </style>
</head>

<body>

<script>
    if (localStorage.getItem("loggedIn") !== "true") {
      document.addEventListener("DOMContentLoaded", function () {
        document.body.innerHTML = `
          <div class="container mt-5">
            <div class="card p-4 shadow-lg mx-auto" style="max-width: 400px;">
              <h2 class="mb-4 text-center text-danger">Login Panitia</h2>
              <form id="loginForm">
                <div class="mb-3">
                  <label>Username</label>
                  <input type="text" class="form-control" id="username" required />
                </div>
                <div class="mb-3">
                  <label>Password</label>
                  <input type="password" class="form-control" id="password" required />
                </div>
                <button class="btn btn-danger w-100">Login</button>
              </form>
              <div id="loginError" class="text-danger text-center mt-3 d-none">Username atau password salah!</div>
            </div>
          </div>
        `;

        document.getElementById("loginForm").addEventListener("submit", function (e) {
          e.preventDefault();
          const user = document.getElementById("username").value;
          const pass = document.getElementById("password").value;
          if (user === "adminDana" && pass === "P@ssw0rd") {
            localStorage.setItem("loggedIn", "true");
            location.reload();
          } else {
            document.getElementById("loginError").classList.remove("d-none");
          }
        });
      });
    }
</script>

<header style="background-image: url('https://fahum.umsu.ac.id/info/wp-content/uploads/2023/08/kemerdekaan-indonesia-upaya-dan-faktor-pendukungnya.jpg'); background-size: cover; background-position: center; color: white; padding: 3rem; text-align: center"
        class="d-flex justify-content-center align-items-center gap-3 p-3 bg-light border-bottom">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/Flag_of_Indonesia.svg" height="40" alt="11">
    <h1 class="m-0 fs-2 text-white fw-bold">Dana Swadaya Lomba 17 Agustus Antar RT</h1>
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/Flag_of_Indonesia.svg" height="40" alt="11">
</header>

<div class="container my-5">

    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-primary me-2" onclick="tampilkanForm()">üìù Formulir</button>
        <button class="btn btn-outline-success" onclick="tampilkanPeserta()">üìã Lihat Dana Diterima</button>
    </div>

    <!-- üëá DIBUNGKUS ID HALAMAN FORM -->
    <div id="halamanForm">
        <div class="card shadow-lg rounded-4 p-4 independence-banner">
            <h2 class="mb-4 text-center text-danger">Formulir Dana Swadaya Warga</h2>
            <form id="lombaForm">
                <div class="mb-3">
                    <label class="form-label">Nama Lengkap Warga</label>
                    <input type="text" name="entry.745998322" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">RT</label>
                    <select name="entry.45144183" class="form-select" required>
                        <option value="">-- Pilih RT --</option>
                        <option value="RT 01">RT 01</option>
                        <option value="RT 02">RT 02</option>
                        <option value="RT 03">RT 03</option>
                        <option value="RT 04">RT 04</option>
                        <option value="RT 05">RT 05</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Alamat</label>
                    <input type="text" name="entry.18454498" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Jumlah Dalam Rupiah</label>
                    <input type="number" name="entry.2084991272" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">No WhatsApp</label>
                    <input
                            type="text"
                            name="entry.783740083"
                            class="form-control"
                            inputmode="numeric"
                            pattern="^\d{10,14}$"
                            minlength="10"
                            maxlength="14"
                            placeholder="Contoh: 081234567890"
                            required
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    >
                </div>

                <div class="mb-3">
                    <label class="form-label">Nama PIC</label>
                    <input type="text" name="entry.1250643604" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-danger w-100 fw-bold">Submit Sumber Dana</button>
            </form>

            <div id="pesanBerhasil" class="alert alert-success mt-4 d-none text-center fw-bold">
                üéâ Terima kasih sudah Berkontribusi! Sampai jumpa di hari H!
                <br>
                <a id="whatsappLink" href="#" class="btn btn-success mt-3" target="_blank">Notifikasi via WhatsApp</a>
            </div>

            <div class="text-end mt-4">
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div id="halamanPeserta" class="card shadow rounded-4 p-4 d-none">
        <h3 class="text-danger text-center mb-4">üë• Daftar Dana Swadaya Warga Terdaftar</h3>
        <h5 class="text-danger mb-3">Total Dana Terkumpul: <span id="totalPeserta">...</span></h5>

        <!--sorting-->
        <div class="mb-3">
            <label for="searchNama" class="form-label">Cari Nama</label>
            <input type="text" id="searchNama" class="form-control" placeholder="Masukkan nama peserta...">
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Filter RT</label>
            <select id="filterRT" class="form-select">
                <option value="">-- Semua RT --</option>
                <option value="RT 01">RT 01</option>
                <option value="RT 02">RT 02</option>
                <option value="RT 03">RT 03</option>
                <option value="RT 04">RT 04</option>
                <option value="RT 05">RT 05</option>
            </select>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="tabelPeserta">
                <thead class="table-danger">
                <tr>
                    <th>No</th>
                    <th>Nama Lengkap Warga</th>
                    <th>RT</th>
                    <th>Alamat</th>
                    <th>Jumlah (Rp)</th>
                    <th>Telepon</th>
                    <th>Nama PIC</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button class="btn btn-outline-secondary btn-sm" id="prevBtn">‚èÆ Prev</button>
            <span id="pageInfo" class="fw-bold"></span>
            <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next ‚è≠</button>
        </div>
    </div>
</div>

<footer class="d-flex justify-content-center align-items-center gap-3 p-3 bg-danger text-white mt-5 rounded-3 shadow-sm">
    <span>&copy; 2025 Pixel Playground Studio</span>
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/Flag_of_Indonesia.svg" alt="Bendera Indonesia" height="30">
</footer>

<script>
    document.getElementById("lombaForm")?.addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);

      fetch("https://docs.google.com/forms/d/e/1FAIpQLSeXoHQWSZEDH4EpH6fVk7c8SG-gaCOD5oimS54zgTot5w7B9A/formResponse", {
        method: "POST",
        mode: "no-cors",
        body: data
      }).then(() => {
        form.classList.add("d-none");
        document.getElementById("pesanBerhasil").classList.remove("d-none");

        const nama = data.get("entry.745998322");
        const jumlah = data.get("entry.2084991272");
        const noHp = data.get("entry.783740083");

        if (noHp) {
          const nomorWa = noHp.replace(/^0/, '62');
          const pesan = `Halo ${nama}, Terima kasih sudah berkontribusi untuk acara 17an sebesar ${jumlah}. Sampai jumpa di acara 17an ya!`;
          const waLink = `https://wa.me/${nomorWa}?text=${encodeURIComponent(pesan)}`;
          document.getElementById("whatsappLink").href = waLink;
          document.getElementById("whatsappLink").classList.remove("d-none");
        }
      }).catch(() => {
        alert("Gagal mengirim. Coba lagi!");
      });
    });

    function logout() {
      localStorage.removeItem("loggedIn");
      location.reload();
    }

    function tampilkanForm() {
      document.getElementById("halamanForm").classList.remove("d-none");
      document.getElementById("halamanPeserta").classList.add("d-none");
    }

    let pesertaData = [];
    let currentPage = 1;
    const perPage = 20;

    function tampilkanPeserta() {
      document.getElementById("halamanForm").classList.add("d-none");
      document.getElementById("halamanPeserta").classList.remove("d-none");

      if (pesertaData.length === 0) {
        fetch("https://opensheet.elk.sh/1YffLudbsbaVcBFEUv9ZiHPqHaJT85Ie6uabJoYZ8jmY/Form+Responses+1")
          .then(res => res.json())
          .then(data => {
            pesertaData = data;
            renderPage();
          });
      } else {
        renderPage();
      }
    }

    function renderPage() {
      const tbody = document.querySelector("#tabelPeserta tbody");
      tbody.innerHTML = "";

       const rtFilter = document.getElementById("filterRT").value;
       const searchNama = document.getElementById("searchNama").value.toLowerCase(); // baru

      // Filter sesuai RT
      const filtered = pesertaData.filter((row) => {
        const rt = row["RT"];
        const rtValid = rtFilter === "" || rt === rtFilter;
        const nama = row["Nama Lengkap"]?.toLowerCase() || "";

          // Filter nama
        const namaValid = nama.includes(searchNama);

        return rtValid && namaValid;

      });

        let totalDana = 0;
          filtered.forEach(row => {
            const jumlah = parseInt((row["Jumlah"] || "0").replace(/[^\d]/g, ""));
            totalDana += isNaN(jumlah) ? 0 : jumlah;
          });
          document.getElementById("totalPeserta").innerText = "Rp " + totalDana.toLocaleString("id-ID");
      const totalPages = Math.ceil(filtered.length / perPage);
      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pageData = filtered.slice(start, end);

      pageData.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${start + i + 1}</td>
          <td>${row["Nama Lengkap"] || "-"}</td>
          <td>${row["RT"] || "-"}</td>
          <td>${row["Alamat"] || "-"}</td>
          <td>${row["Jumlah"] || "-"}</td>
          <td>${row["Nomor Telepon"] || "-"}</td>
          <td>${row["PIC"] || "-"}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("pageInfo").innerText = `Halaman ${currentPage} dari ${totalPages}`;
      document.getElementById("prevBtn").disabled = currentPage === 1;
      document.getElementById("nextBtn").disabled = currentPage === totalPages;
    }

    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      const totalPages = Math.ceil(pesertaData.length / perPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderPage();
      }
    });

    document.getElementById("filterRT").addEventListener("change", () => {
      currentPage = 1;
      renderPage();
    });

    document.getElementById("searchNama").addEventListener("input", () => {
      currentPage = 1;
      renderPage();
    });
</script>

</body>
</html>
